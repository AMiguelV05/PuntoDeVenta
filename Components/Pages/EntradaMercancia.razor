@page "/entrada-mercancia"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using PuntoDeVenta.Data
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IJSRuntime JSRuntime
@inject NavigationManager NavManager
@inject EstadoAutenticacionService AuthService
@inject NotificationService Notifier

<PageTitle>Entrada de Mercancía</PageTitle>

<div class="container-fluid pt-3">
    <h3 class="mb-3 text-primary"><i class="bi bi bi-cart-plus-fill me-2"></i>Recepción de Mercancía</h3>

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-secondary text-white fw-bold">
                    <i class="bi bi-search me-2"></i> Agregar Productos a la Entrada
                </div>
                <div class="card-body p-3 position-relative">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-upc"></i></span>
                        <input type="text" class="form-control" placeholder="Buscar producto por nombre o SKU..." 
                               @bind="terminoBusqueda" @oninput="BuscarProductos" />
                    </div>
                    @if (resultadosBusqueda.Any())
                    {
                        <ul class="list-group position-absolute w-100 mt-2 shadow-lg" style="z-index: 1000;">
                            @foreach (var prod in resultadosBusqueda)
                            {
                                <li class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                    @onclick="() => AgregarAlListado(prod)" style="cursor: pointer;">
                                    <div>
                                        <strong>@prod.Nombre</strong>
                                        <div class="small text-muted">SKU: @prod.CodigoSku | Stock Actual: @prod.StockActual</div>
                                    </div>
                                    <span class="badge bg-success">Costo: @(prod.PrecioCompra?.ToString("C") ?? "$0.00")</span>
                                </li>
                            }
                        </ul>
                    }
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped align-middle mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Producto</th>
                                    <th style="width: 15%;">Cant. Entrante</th>
                                    <th style="width: 15%;">Costo Unit.</th>
                                    <th class="text-end">Subtotal</th>
                                    <th style="width: 50px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (!detallesEntrada.Any())
                                {
                                    <tr><td colspan="5" class="text-center py-4 text-muted">Agrega productos para registrar la entrada.</td></tr>
                                }
                                @foreach (var item in detallesEntrada)
                                {
                                    <tr>
                                        <td>@item.Producto?.Nombre</td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm" @bind="item.Cantidad" min="1" />
                                        </td>
                                        <td>
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" @bind="item.CostoUnitario" />
                                            </div>
                                        </td>
                                        <td class="text-end fw-bold">@((item.Cantidad * item.CostoUnitario).ToString("C"))</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => detallesEntrada.Remove(item)"><i class="bi bi-trash"></i></button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-lg">
                <div class="card-header bg-success text-white fw-bold">
                    <i class="bi bi-file-earmark-text me-2"></i> Datos de la Entrada
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Proveedor:</label>
                        <InputSelect @bind-Value="idProveedorSeleccionado" class="form-select">
                            <option value="0">-- Seleccione Proveedor --</option>
                            @foreach (var p in listaProveedores)
                            {
                                <option value="@p.ProveedorId">@p.Nombre</option>
                            }
                        </InputSelect>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded">
                        <span class="h5 m-0">Total Compra:</span>
                        <span class="h4 m-0 text-success fw-bold">@detallesEntrada.Sum(d => d.Cantidad * d.CostoUnitario).ToString("C")</span>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg" @onclick="GuardarEntrada" 
                                disabled="@(!detallesEntrada.Any() || idProveedorSeleccionado == 0)">
                            <i class="bi bi-save me-2"></i>Registrar Entrada
                        </button>
                        <button class="btn btn-outline-secondary" @onclick="LimpiarFormulario">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string terminoBusqueda = "";
    private List<Producto> resultadosBusqueda = new();
    private List<DetalleEntrada> detallesEntrada = new();
    private List<Proveedor> listaProveedores = new();
    private long idProveedorSeleccionado;

    protected override async Task OnInitializedAsync()
    {
        if (AuthService.EmpleadoActual == null)
        {
            NavManager.NavigateTo("/login");
            return;
        }
        if (AuthService.EmpleadoActual.Puesto == "en espera")
        {
            _ = Notifier.SetMessage("Acceso no autorizado. Por favor, espera a que un Admin te conceda el acceso.", "warning", 3000);
            NavManager.NavigateTo("/");
            return;
        }
        using var db = DbFactory.CreateDbContext();
        listaProveedores = await db.Proveedores.AsNoTracking().OrderBy(p => p.Nombre).ToListAsync();
    }

    private async Task BuscarProductos(ChangeEventArgs e)
    {
        terminoBusqueda = e.Value?.ToString() ?? "";
        if (terminoBusqueda.Length < 2) { resultadosBusqueda.Clear(); return; }

        var termino = terminoBusqueda.ToLower();
        using var db = DbFactory.CreateDbContext();
        resultadosBusqueda = await db.Productos.AsNoTracking()
            .Where(p => p.Nombre.ToLower().Contains(termino) || p.CodigoSku.ToLower().Contains(termino))
            .Take(10).ToListAsync();
    }

    private void AgregarAlListado(Producto p)
    {
        if (detallesEntrada.Any(d => d.ProductoId == p.ProductoId)) {
             _ = Notifier.SetMessage("El producto ya está en la lista.", "warning");
             return;
        }

        detallesEntrada.Add(new DetalleEntrada
        {
            ProductoId = p.ProductoId,
            Producto = p,
            Cantidad = 1,
            CostoUnitario = p.PrecioCompra ?? 0 // Sugiere el último precio de compra
        });
        terminoBusqueda = "";
        resultadosBusqueda.Clear();
    }

    private async Task GuardarEntrada()
    {
        using var db = DbFactory.CreateDbContext();
        using var transaccion = await db.Database.BeginTransactionAsync();

        try
        {
            var entrada = new Entrada
            {
                Fecha = DateTimeOffset.UtcNow,
                ProveedorId = idProveedorSeleccionado,
                EmpleadoId = AuthService.EmpleadoActual!.EmpleadoId
            };

            await db.Entradas.AddAsync(entrada);
            await db.SaveChangesAsync();

            int linea = 1;
            foreach (var item in detallesEntrada)
            {
                item.EntradaId = entrada.EntradaId;
                item.LineaNum = linea++;
                item.Producto = null;

                await db.DetallesEntrada.AddAsync(item);

                var productoDb = await db.Productos.FindAsync(item.ProductoId);
                if (productoDb != null)
                {
                    productoDb.StockActual += (int)item.Cantidad;
                    productoDb.PrecioCompra = item.CostoUnitario; 
                }
            }

            await db.SaveChangesAsync();
            await transaccion.CommitAsync();
            
            _ = Notifier.SetMessage("Entrada registrada y stock actualizado.", "success");
            LimpiarFormulario();
        }
        catch (Exception ex)
        {
            await transaccion.RollbackAsync();
            _ = Notifier.SetMessage($"Error: {ex.Message}", "danger");
        }
    }

    private void LimpiarFormulario()
    {
        detallesEntrada.Clear();
        idProveedorSeleccionado = 0;
        terminoBusqueda = "";
    }
}