@page "/reportes/ventas"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using PuntoDeVenta.Data
@using System.Threading.Tasks
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NotificationService Notifier
@inject EstadoAutenticacionService AuthService
@inject NavigationManager NavManager
@inject IJSRuntime JSRuntime

<PageTitle>Reporte de Ventas</PageTitle>

<div class="container-fluid pt-3">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="text-primary m-0">
            <i class="bi bi-bar-chart-line me-2"></i>Reporte de Ventas
        </h3>
    </div>

    <div class="card shadow-lg border-0">
        <div class="card-header bg-white py-3">
            <div class="row g-3 align-items-center">
                <div class="col-md-4 col-lg-3">
                    <div class="input-group">
                        <span class="input-group-text bg-light text-primary border-end-0">
                            <i class="bi bi-calendar-event"></i>
                        </span>
                        <InputDate @bind-Value="fechaInicio" class="form-control border-start-0" />
                    </div>
                </div>

                <div class="col-auto text-muted">
                    <i class="bi bi-arrow-right"></i>
                </div>

                <div class="col-md-4 col-lg-3">
                    <div class="input-group">
                        <span class="input-group-text bg-light text-primary border-end-0">
                            <i class="bi bi-calendar-check"></i>
                        </span>
                        <InputDate @bind-Value="fechaFin" class="form-control border-start-0" />
                    </div>
                </div>

                <div class="col-auto">
                    <button class="btn btn-success shadow-sm" @onclick="CargarReporte">
                        <i class="bi bi-search me-2"></i>Generar Reporte
                    </button>
                </div>
            </div>
        </div>

        <div class="card-body p-0">
            @if (ventas == null)
            {
                <div class="p-5 text-center text-muted">
                    <i class="bi bi-calendar-range display-4 d-block mb-2"></i>
                    <p class="fs-5">Selecciona un rango de fechas para comenzar.</p>
                </div>
            }
            else if (!ventas.Any())
            {
                <div class="p-5 text-center text-muted">
                    <div class="spinner-border text-primary mb-2" role="status" style="display: none;"></div> <i class="bi bi-inbox display-4 d-block mb-2"></i>
                    <p class="fs-5">No se encontraron ventas entre el <strong>@fechaInicio.ToShortDateString()</strong> y el <strong>@fechaFin.ToShortDateString()</strong>.</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover table-striped align-middle mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th class="ps-3">ID Venta</th>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th class="text-end">Total</th>
                                <th class="text-center" style="width: 150px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var v in ventas)
                            {
                                <tr>
                                    <td class="ps-3">
                                        <span class="badge bg-light text-dark border">
                                            #@v.VentaId
                                        </span>
                                    </td>
                                    <td>
                                        <i class="bi bi-clock me-1 text-muted"></i>
                                        @v.FechaVenta.LocalDateTime.ToString("g")
                                    </td>
                                    <td>
                                        <span class="fw-bold text-secondary">
                                            @(v.Cliente?.Nombre ?? "Público General")
                                        </span>
                                    </td>
                                    <td class="text-end fw-bold text-success">@v.Total.ToString("C")</td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-primary shadow-sm" @onclick="() => VerDetalle(v.VentaId)" title="Ver Detalle">
                                            <i class="bi bi-eye me-1"></i>Ver
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                
                <div class="card-footer bg-light py-3">
                    <div class="row align-items-center">
                        
                        <div class="col-md-4 text-muted small mb-2 mb-md-0">
                            Mostrando @ventas.Count de @totalRegistros ventas.
                        </div>

                        <div class="col-md-4 d-flex justify-content-center mb-2 mb-md-0">
                            <nav aria-label="Navegación de ventas">
                                <ul class="pagination pagination-sm mb-0 shadow-sm">
                                    <li class="page-item @(paginaActual == 1 ? "disabled" : "")">
                                        <button class="page-link" @onclick="() => CambiarPagina(paginaActual - 1)" aria-label="Anterior">
                                            <span aria-hidden="true">&laquo;</span>
                                        </button>
                                    </li>
                                    
                                    <li class="page-item disabled">
                                        <span class="page-link text-dark bg-white border-top border-bottom">
                                            Pág @paginaActual / @(totalPaginas == 0 ? 1 : totalPaginas)
                                        </span>
                                    </li>

                                    <li class="page-item @(paginaActual == totalPaginas || totalPaginas == 0 ? "disabled" : "")">
                                        <button class="page-link" @onclick="() => CambiarPagina(paginaActual + 1)" aria-label="Siguiente">
                                            <span aria-hidden="true">&raquo;</span>
                                        </button>
                                    </li>
                                </ul>
                            </nav>
                        </div>

                        <div class="col-md-4 text-md-end">
                            <span class="fs-6 fw-bold text-primary">
                                Total Periodo: 
                                <span class="text-success">@totalDineroPeriodo.ToString("C")</span>
                            </span>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<div class="modal fade" id="detalleVentaModal" tabindex="-1" aria-labelledby="detalleVentaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            @if (ventaSeleccionada != null)
            {
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-receipt me-2"></i>Detalle de Venta #@ventaSeleccionada.VentaId
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarDetalle" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <div class="row mb-4 bg-light rounded p-3 mx-1 border">
                        <div class="col-md-6">
                            <label class="small text-muted text-uppercase fw-bold">Cliente</label>
                            <div class="fs-6 fw-bold text-dark">@(ventaSeleccionada.Cliente?.Nombre ?? "Público General")</div>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <label class="small text-muted text-uppercase fw-bold">Atendido por</label>
                            <div class="fs-6">
                                <i class="bi bi-person-badge me-1"></i>@(ventaSeleccionada.Empleado?.Nombre ?? "N/A")
                            </div>
                        </div>
                        <div class="col-12 mt-2 border-top pt-2 d-flex justify-content-between">
                             <span><i class="bi bi-calendar3 me-1"></i>@ventaSeleccionada.FechaVenta.LocalDateTime.ToString("f")</span>
                             <span class="badge bg-info text-dark">
                                 @(ventaSeleccionada.AplicarIVA == true ? "IVA Incluido (16%)" : "Sin desglose fiscal")
                             </span>
                        </div>
                    </div>

                    <h6 class="text-secondary border-bottom pb-2 mb-3">Productos Vendidos</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Producto</th>
                                    <th class="text-center">Cant.</th>
                                    <th class="text-end">P. Unit.</th>
                                    <th class="text-end">Desc.</th>
                                    <th class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var det in ventaSeleccionada.DetalleVentas)
                                {
                                    <tr>
                                        <td class="fw-bold text-secondary">@det.Producto.Nombre</td>
                                        <td class="text-center">@det.Cantidad</td>
                                        <td class="text-end">@det.PrecioUnitario.ToString("C")</td>
                                        <td class="text-end text-danger">
                                            @if(det.Descuento > 0) { <small>-@det.Descuento.ToString("C")</small> } else { <span>-</span> }
                                        </td>
                                        <td class="text-end fw-bold">@((det.Cantidad * det.PrecioUnitario - det.Descuento).ToString("C"))</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="row justify-content-end mt-3">
                        <div class="col-md-5">
                            <ul class="list-group">
                                @if (ventaSeleccionada.AplicarIVA == true)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-2 py-1 border-0">
                                        <span class="small text-muted">Subtotal:</span>
                                        <span>@((ventaSeleccionada.Total / 1.16m).ToString("C"))</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-2 py-1 border-0">
                                        <span class="small text-muted">IVA (16%):</span>
                                        <span>@((ventaSeleccionada.Total - (ventaSeleccionada.Total / 1.16m)).ToString("C"))</span>
                                    </li>
                                }
                                <li class="list-group-item d-flex justify-content-between align-items-center bg-light border rounded mt-1">
                                    <span class="fw-bold text-primary">TOTAL PAGADO</span>
                                    <span class="fw-bold fs-5 text-success">@ventaSeleccionada.Total.ToString("C")</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarDetalle">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="window.print()">
                        <i class="bi bi-printer me-2"></i>Imprimir
                    </button>
                </div>
            }
            else
            {
                <div class="modal-body text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Cargando detalles...</p>
                </div>
            }
        </div>
    </div>
</div>

<style>
    @@media print {
        body {
            visibility: hidden;
        }

        .container-fluid, .sidebar, .top-row {
            display: none !important; 
        }

        #detalleVentaModal {
            visibility: visible !important;
            position: absolute !important;
            left: 0 !important;
            top: 0 !important;
            width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            
            display: block !important; 
            overflow: visible !important;
        }

        #detalleVentaModal * {
            visibility: visible !important;
        }

        .modal-backdrop {
            display: none !important;
        }
        
        .modal-content {
            border: none !important;
            box-shadow: none !important;
        }

        .modal-header .btn-close, 
        .modal-footer {
            display: none !important;
        }
        
        .modal-header {
            border-bottom: 1px solid #000 !important;
        }
        
        .modal-body {
            background-color: white !important;
            color: black !important;
        }
    }
</style>

@code {
    private List<Venta>? ventas;
    private Venta? ventaSeleccionada;
    private DateTime fechaInicio = DateTime.Today.AddDays(-7);
    private DateTime fechaFin = DateTime.Today;

    // Paginación
    private int paginaActual = 1;
    private int elementosPorPagina = 20;
    private int totalPaginas = 0;
    private int totalRegistros = 0;
    private decimal totalDineroPeriodo = 0;

    protected override async Task OnInitializedAsync()
    {
        if (AuthService.EmpleadoActual == null)
        {
            NavManager.NavigateTo("/login");
            return;
        }
        if (AuthService.EmpleadoActual.Puesto == "en espera")
        {
            _ = Notifier.SetMessage("Acceso no autorizado. Por favor, espera a que un Admin te conceda el acceso.", "warning", 3000);
            NavManager.NavigateTo("/");
            return;
        }
    }

    private async Task CargarReporte()
    {
        paginaActual = 1;
        await CargarDatosPaginados();
    }
    private async Task CambiarPagina(int nuevaPagina)
    {
        if (nuevaPagina < 1 || nuevaPagina > totalPaginas) return;

        paginaActual = nuevaPagina;
        await CargarDatosPaginados();
    }
    private async Task CargarDatosPaginados()
    {
        var fechaInicioUtc = fechaInicio.Date.ToUniversalTime();
        var fechaFinUtc = fechaFin.Date.AddDays(1).ToUniversalTime();

        using var db = DbFactory.CreateDbContext();

        var queryBase = db.Ventas
            .Include(v => v.Cliente)
            .Where(v => v.FechaVenta >= fechaInicioUtc && v.FechaVenta <= fechaFinUtc);


        totalRegistros = await queryBase.CountAsync();

        if (totalRegistros > 0)
        {
            totalDineroPeriodo = await queryBase.SumAsync(v => v.Total);
        }
        else
        {
            totalDineroPeriodo = 0;
        }

        if (totalRegistros > 0 && elementosPorPagina > 0)
        {
             totalPaginas = (int)Math.Ceiling(totalRegistros / (double)elementosPorPagina);
        }
        else 
        {
             totalPaginas = 0;
        }

        ventas = await queryBase
            .OrderByDescending(v => v.FechaVenta)
            .Skip((paginaActual - 1) * elementosPorPagina) // Saltar los anteriores
            .Take(elementosPorPagina) // Tomar solo el bloque actual
            .AsNoTracking()
            .ToListAsync();
    }

    private async Task VerDetalle(long ventaId)
    {
        ventaSeleccionada = null;
        await JSRuntime.InvokeVoidAsync("bootstrapModalFunctions.show", "detalleVentaModal");

        using var db = DbFactory.CreateDbContext();
        ventaSeleccionada = await db.Ventas
            .Include(v => v.Cliente)
            .Include(v => v.DetalleVentas)
                .ThenInclude(d => d.Producto)
            .Include(v => v.Empleado)
            .AsNoTracking()
            .FirstOrDefaultAsync(v => v.VentaId == ventaId);
    }

    private async Task CerrarDetalle()
    {
        await JSRuntime.InvokeVoidAsync("bootstrapModalFunctions.hide", "detalleVentaModal");
        ventaSeleccionada = null;
    }
}