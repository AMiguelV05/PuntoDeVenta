@page "/venta"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using PuntoDeVenta.Data
@using System.Threading.Tasks
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IJSRuntime JSRuntime
@inject NavigationManager NavManager
@inject EstadoAutenticacionService AuthService
@inject NotificationService Notifier

<PageTitle>Terminal de Ventas</PageTitle>

<div class="container-fluid pt-3">
    
    <h3 class="mb-3 text-primary"> <i class="bi bi-cart-fill"></i> Terminal de Venta</h3>
    
    <div class="row">
        
        <div class="col-lg-7">
            
            <div class="card mb-3 shadow-sm border-dark">
                <div class="card-header bg-secondary text-white fw-bold">
                    <i class="bi bi-search me-2"></i> Búsqueda Rápida de Producto
                </div>
                <div class="card-body p-3 position-relative">
                    <div class="input-group">
                        <span class="input-group-text bg-light"><i class="bi bi-upc-scan"></i></span>
                        <InputText @bind-Value="terminoBusqueda" 
                                   class="form-control form-control-lg" 
                                   @oninput="BuscarProductos" 
                                   placeholder="Escribe nombre o código SKU..." />
                    </div>
                
                    @if (resultadosBusqueda.Any())
                    {
                        <ul class="list-group position-absolute w-100 mt-2 shadow-lg" style="z-index: 1000;">
                            @foreach (var prod in resultadosBusqueda)
                            {
                                <li class="list-group-item list-group-item-action d-flex justify-content-between align-items-center p-2">
                                    <span class="me-auto">
                                        <strong>@prod.Nombre</strong> (@prod.StockActual disp.)
                                        <small class="text-muted d-block">SKU: @prod.CodigoSku</small>
                                    </span>
                                    <span class="badge bg-secondary me-3">@prod.PrecioVenta.ToString("C")</span>
                                    <button class="btn btn-sm btn-success" 
                                            @onclick="() => AgregarAlCarrito(prod)" 
                                            disabled="@(prod.StockActual <= 0)">
                                        <i class="bi bi-plus-circle"></i> Agregar
                                    </button>
                                </li>
                            }
                        </ul>
                    }
                </div>
            </div>

            <h4 class="mt-4 mb-2 text-secondary">Artículos en Carrito</h4>
            <div class="table-responsive bg-white rounded shadow-sm">
                <table class="table table-striped table-hover table-sm mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 15%;">Cantidad</th>
                            <th>Producto</th>
                            <th class="text-end" style="width: 15%;">Precio Unit.</th>
                            <th class="text-end" style="width: 15%;">Subtotal</th>
                            <th class="text-end" style="width: 15%;">Descuento</th>
                            <th style="width: 5%;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (!carrito.Any())
                        {
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">
                                    <i class="bi bi-cart-x-fill me-2"></i> El carrito está vacío.
                                </td>
                            </tr>
                        }
                        @foreach (var item in carrito)
                        {
                            <tr>
                                <td>
                                    <input type="number" 
                                           @bind-Value="item.Cantidad" 
                                           @bind-Value:event="oninput" 
                                           step="any" 
                                           class="form-control form-control-sm text-center"
                                           min="1" />
                                </td>
                                <td>@item.Producto.Nombre</td>
                                <td class="text-end">@item.PrecioUnitario.ToString("C")</td>
                                <td class="text-end fw-bold text-primary">@((item.Cantidad * item.PrecioUnitario).ToString("C"))</td>
                                <td class="">
                                    <div class="input-group input-group-sm mx-auto">
                                        <span class="input-group-text">$</span>
                                        <input type="number" 
                                            @bind-Value="item.Descuento" 
                                            @bind-Value:event="oninput" 
                                            step="any" 
                                            class="form-control form-control-sm text-center" 
                                            min="0" />
                                    </div>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger border-0" 
                                            @onclick="() => EliminarDelCarrito(item)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            
        </div>

        <div class="col-lg-5">
            <div class="card shadow-lg">
                <div class="card-header bg-success text-white fw-bold h5">
                    <i class="bi bi-receipt me-2"></i> Resumen de Venta
                </div>
                <div class="card-body">
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold text-secondary">Cliente:</label>
                        <InputSelect @bind-Value="ventaActual.ClienteId" class="form-select form-select-lg">
                            <option value="0">(Público General)</option>
                            @foreach (var cli in clientesDisponibles)
                            {
                                <option value="@cli.ClienteId">@cli.Nombre</option>
                            }
                        </InputSelect>
                    </div>
                    
                    <hr />
                    
                    <dl class="row mb-0">
                        <dt class="col-sm-6 fs-5 text-danger">Descuento Total:</dt>
                        @if (descuentoTotal>total){
                            <dd class="col-sm-6 text-end fs-5 text-danger">-@descuentoTotal.ToString("C")</dd>
                        }
                        else{
                            <dd class="col-sm-6 text-end fs-5 text-secondary">-@descuentoTotal.ToString("C")</dd>
                        }

                        <dt class="col-sm-6 fs-5">Subtotal Base:</dt>
                        <dd class="col-sm-6 text-end fs-5 text-secondary">@subtotal.ToString("C")</dd>
                        
                        <dt class="col-sm-6 fs-5 d-flex align-items-center">IVA (16%):
                                <div class="form-check form-switch ms-2">
                                    <InputCheckbox @bind-Value="aplicarIVA" class="form-check-input"/>
                                </div>
                        </dt>
                        <dd class="col-sm-6 text-end fs-5 text-secondary">@iva.ToString("C")</dd>
                    </dl>
                    
                    <div class="p-3 mt-3 bg-dark text-white rounded">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 class="m-0">TOTAL:</h3>
                            <h1 class="m-0 text-warning">@total.ToString("C")</h1>
                        </div>
                    </div>
                    
                    <hr />
                    
                    <div class="d-grid gap-3">
                        <button class="btn btn-lg btn-success shadow-sm" 
                                @onclick="FinalizarVenta" 
                                disabled="@(!carrito.Any())">
                            <i class="bi bi-check-circle me-2"></i> Cobrar y Finalizar Venta (F12)
                        </button>
                        <button class="btn btn-lg btn-outline-danger" 
                                @onclick="LimpiarVenta" 
                                disabled="@(!carrito.Any())">
                            <i class="bi bi-trash me-2"></i> Cancelar Venta
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="paymentModalLabel">
                    <i class="bi bi-cash-coin me-2"></i> Procesar Pago - Total: @total.ToString("C")
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Tipo de Pago:</label>
                    <InputSelect @bind-Value="tipoPago" class="form-select form-select-lg">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Tarjeta">Tarjeta de Crédito/Débito</option>
                        <option value="Transferencia">Transferencia</option>
                    </InputSelect>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">Monto Recibido (@total.ToString("C") total):</label>
                    <input type="number" @bind-value="montoRecibido" 
                           @bind-value:event="oninput" 
                           min="@total" 
                           class="form-control form-control-lg text-end" 
                           placeholder="0.00" />
                </div>

                <div class="alert alert-info text-center h4" role="alert">
                    Cambio a Devolver: <span class="fw-bold text-success">@cambio.ToString("C")</span>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success btn-lg" 
                        @onclick="ConfirmarPago" 
                        disabled="@(montoRecibido < total)">
                    Finalizar Cobro
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    private string terminoBusqueda = "";
    private List<Producto> resultadosBusqueda = new();
    private List<DetalleVenta> carrito = new();
    private List<Cliente> clientesDisponibles = new();
    private string tipoPago = "Efectivo";
    private decimal montoRecibido = 0m;
    private bool aplicarIVA = true;
    private decimal descuentoTotal => carrito.Sum(item => item.Descuento);
    private decimal cambio => montoRecibido > total ? montoRecibido - total : 0m;
    private Venta ventaActual = new();
    private decimal subtotal => carrito.Sum(item => (item.Cantidad * item.PrecioUnitario) - item.Descuento);
    private decimal iva => aplicarIVA ? subtotal * 0.16m : 0m; // 16% de IVA
    private decimal total => subtotal + iva;   // La suma de los dos de arriba

    protected override async Task OnInitializedAsync()
    {
        if (AuthService.EmpleadoActual == null)
        {
            NavManager.NavigateTo("/login");
            return;
        }
        if (AuthService.EmpleadoActual.Puesto == "en espera")
        {
            _ = Notifier.SetMessage("Acceso no autorizado. Por favor, espera a que un Admin te conceda el acceso.", "warning", 3000);
            NavManager.NavigateTo("/");
            return;
        }
        // Cargar clientes para el selector
        using var db = DbFactory.CreateDbContext();
        clientesDisponibles = await db.Clientes.AsNoTracking().OrderBy(c => c.Nombre).ToListAsync();
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Llama a la función JS para configurar los atajos de teclado
            await JSRuntime.InvokeVoidAsync("setupKeyboardShortcuts", DotNetObjectReference.Create(this));
        }
    }
    private async Task BuscarProductos(ChangeEventArgs e)
    {
        terminoBusqueda = e.Value?.ToString() ?? "";
        if (string.IsNullOrWhiteSpace(terminoBusqueda) || terminoBusqueda.Length < 2)
        {
            resultadosBusqueda.Clear();
            return;
        }

        using var db = DbFactory.CreateDbContext();
        resultadosBusqueda = await db.Productos
            .Where(p => p.Nombre.ToLower().Contains(terminoBusqueda.ToLower()) ||
                        p.CodigoSku.ToLower().Contains(terminoBusqueda.ToLower()))
            .OrderBy(p => p.Nombre)
            .AsNoTracking()
            .Take(10) // Limitar resultados para no saturar
            .ToListAsync();
    }

    private void AgregarAlCarrito(Producto prod)
    {
        if (prod.StockActual <= 0)
        {
            _ = Notifier.SetMessage("No hay stock de este producto.", "warning");
            return;
        }

        var itemExistente = carrito.FirstOrDefault(i => i.ProductoId == prod.ProductoId);
        if (itemExistente != null)
        {
            if(itemExistente.Cantidad < prod.StockActual)
            {
                itemExistente.Cantidad++;
            }
            else
            {
                _ = Notifier.SetMessage("No hay más stock disponible.", "warning");
            }
        }
        else
        {
            carrito.Add(new DetalleVenta
            {
                ProductoId = prod.ProductoId,
                Producto = prod, // Guardamos la referencia para el nombre en la tabla
                Cantidad = 1,
                PrecioUnitario = prod.PrecioVenta,
                Descuento = 0m
            });
        }

        terminoBusqueda = "";
        resultadosBusqueda.Clear();
    }

    private void EliminarDelCarrito(DetalleVenta item)
    {
        carrito.Remove(item);
    }

    private void LimpiarVenta()
    {
        carrito.Clear();
        ventaActual = new();
        terminoBusqueda = "";
        resultadosBusqueda.Clear();
        aplicarIVA = true;
    }

    private async Task MostrarModalPago()
    {
        if (!carrito.Any()) return;
        montoRecibido = total; // Valor por defecto
        tipoPago = "Efectivo";

        StateHasChanged();

        await JSRuntime.InvokeVoidAsync("bootstrapModalFunctions.show", "paymentModal");
    }

    private Task FinalizarVenta()
    {
        return MostrarModalPago();
    }
    private async Task ConfirmarPago()
    {
        await JSRuntime.InvokeVoidAsync("bootstrapModalFunctions.hide", "paymentModal");

        using var db = DbFactory.CreateDbContext();
        using var transaccion = await db.Database.BeginTransactionAsync();
        try
        {
            var productoIds = carrito.Select(item => item.ProductoId).Distinct().ToList();
            var productosEnDb = await db.Productos
                .Where(p => productoIds.Contains(p.ProductoId))
                .ToDictionaryAsync(p => p.ProductoId);

            ventaActual.FechaVenta = DateTime.UtcNow;
            ventaActual.Total = total;
            ventaActual.ClienteId = ventaActual.ClienteId == 0 ? null : ventaActual.ClienteId;
            ventaActual.EmpleadoId = AuthService.EmpleadoActual!.EmpleadoId;
            ventaActual.AplicarIVA = aplicarIVA;
            // ventaActual.TipoPago = tipoPago; 
            // ventaActual.MontoRecibido = montoRecibido;

            await db.Ventas.AddAsync(ventaActual);
            await db.SaveChangesAsync(); 

            int lineaCounter = 1;
            foreach (var item in carrito)
            {
                item.VentaId = ventaActual.VentaId;
                item.LineaNum = lineaCounter;
                item.Producto = null!; 
                await db.DetalleVentas.AddAsync(item);

                if (productosEnDb.TryGetValue(item.ProductoId, out var producto) && producto.StockActual >= item.Cantidad)
                {
                    producto.StockActual -= item.Cantidad;
                    db.Productos.Update(producto);
                }
                else
                {
                    throw new Exception($"Stock insuficiente para {producto?.Nombre ?? "Producto desconocido"}.");
                }
                lineaCounter++;
            }

            await db.SaveChangesAsync();
            await transaccion.CommitAsync();

            // Mensaje de éxito final, mostrando el cambio si aplica
            string mensajeFinal = cambio > 0 
                ? $"¡Venta realizada con éxito!\nTotal: {total:C}\nRecibido: {montoRecibido:C}\nCambio a devolver: {cambio:C}" 
                : $"¡Venta realizada con éxito! Total: {total:C}";

            _ = Notifier.SetMessage(mensajeFinal, "succes", 5000);
            LimpiarVenta();
        }
        catch (Exception ex)
        {
            await transaccion.RollbackAsync();
            _ = Notifier.SetMessage($"Error al guardar la venta: {ex.Message}", "error");
            await MostrarModalPago(); 
        }
    }
    [JSInvokable]
    public async Task HandleF12Shortcut(){
        if (carrito.Any()){
            await MostrarModalPago();
        }
        else{
            _ = Notifier.SetMessage("Aún no hay productos en el carrito.", "error");
        }
    }
}